<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Digging Simulation</title>
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background: #cce0ff; }
    canvas { display: block; }
  </style>
</head>
<body>
<script>
const { Engine, Render, Runner, Bodies, World, Body, Mouse, MouseConstraint, Composite, Constraint, Events, Vector } = Matter;

// engine & world
const engine = Engine.create();
const world = engine.world;
world.gravity.y = 1;

// renderer
const render = Render.create({
  element: document.body,
  engine: engine,
  options: {
    width: window.innerWidth,
    height: window.innerHeight,
    wireframes: false,
    background: "#cce0ff"
  }
});
Render.run(render);

// runner
const runner = Runner.create();
Runner.run(runner, engine);

// ground
const ground = Bodies.rectangle(window.innerWidth / 2, window.innerHeight - 20, window.innerWidth, 40, { isStatic: true, render: { fillStyle: "#654321" }});
World.add(world, ground);

// soil blocks
const blocks = [];
const blockSize = 15;
for (let x = 100; x < window.innerWidth - 100; x += blockSize) {
  for (let y = window.innerHeight/2; y < window.innerHeight - 50; y += blockSize) {
    const block = Bodies.rectangle(x, y, blockSize, blockSize, {
      restitution: 0.05, // less bouncy
      friction: 0.9,
      density: 0.002,
      render: { fillStyle: "#8b4513" }
    });
    blocks.push(block);
  }
}
World.add(world, blocks);

// spade
const spade = Bodies.rectangle(200, 200, 120, 20, {
  density: 0.01,
  friction: 0.8,
  frictionStatic: 0.9,
  restitution: 0,
  render: { fillStyle: "#aaaaaa" }
});
World.add(world, spade);

// mouse control
const mouse = Mouse.create(render.canvas);
render.mouse = mouse;

// instead of MouseConstraint, directly follow mouse
Events.on(engine, "beforeUpdate", () => {
  const target = { x: mouse.position.x, y: mouse.position.y };
  const angle = Math.atan2(target.y - spade.position.y, target.x - spade.position.x);
  
  // smoothly move towards mouse
  Body.setVelocity(spade, {
    x: (target.x - spade.position.x) * 0.2,
    y: (target.y - spade.position.y) * 0.2
  });
  
  // lock angle so it stays scoop-like
  Body.setAngle(spade, angle);
});

// soft soil behavior: mild attraction between close blocks
Events.on(engine, "afterUpdate", () => {
  for (let i = 0; i < blocks.length; i++) {
    for (let j = i + 1; j < blocks.length; j++) {
      const b1 = blocks[i], b2 = blocks[j];
      const dx = b2.position.x - b1.position.x;
      const dy = b2.position.y - b1.position.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < blockSize * 1.5) {
        const force = 0.00005;
        Body.applyForce(b1, b1.position, { x: dx * force, y: dy * force });
        Body.applyForce(b2, b2.position, { x: -dx * force, y: -dy * force });
      }
    }
  }
});
</script>
</body>
</html>
