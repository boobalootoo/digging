<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Digging Simulation</title>
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background: #cce0ff; }
    canvas { display: block; }
  </style>
</head>
<body>
<script>
const { Engine, Render, Runner, Bodies, Body, World, Events, Mouse } = Matter;

// engine & world
const engine = Engine.create();
const world = engine.world;
world.gravity.y = 1;

// renderer
const width = window.innerWidth;
const height = window.innerHeight;
const render = Render.create({
  element: document.body,
  engine: engine,
  options: {
    width,
    height,
    wireframes: false,
    background: "#cce0ff"
  }
});
Render.run(render);
Runner.run(Runner.create(), engine);

// boundaries
const wallThickness = 50;
World.add(world, [
  Bodies.rectangle(width/2, height+wallThickness/2, width, wallThickness, { isStatic: true }),
  Bodies.rectangle(width/2, -wallThickness/2, width, wallThickness, { isStatic: true }),
  Bodies.rectangle(-wallThickness/2, height/2, wallThickness, height, { isStatic: true }),
  Bodies.rectangle(width+wallThickness/2, height/2, wallThickness, height, { isStatic: true })
]);

// soil blocks (15px grid across bottom third of screen)
const blocks = [];
const blockSize = 15;
const groundHeight = Math.floor(height / 3);
for (let y = height - groundHeight; y < height - blockSize; y += blockSize) {
  for (let x = blockSize; x < width - blockSize; x += blockSize) {
    const block = Bodies.rectangle(x, y, blockSize, blockSize, {
      restitution: 0,
      friction: 0.9,
      frictionStatic: 1,
      density: 0.002,
      render: { fillStyle: "#8b5a2b" }
    });
    blocks.push(block);
  }
}
World.add(world, blocks);

// spade (concave scoop)
const spadeParts = [
  Bodies.rectangle(0, 0, 120, 20, { render: { fillStyle: "#aaaaaa" } }),
  Bodies.rectangle(-50, -20, 20, 60, { render: { fillStyle: "#aaaaaa" } }),
  Bodies.rectangle(50, -20, 20, 60, { render: { fillStyle: "#aaaaaa" } })
];
const spade = Body.create({
  parts: spadeParts,
  friction: 0.9,
  frictionStatic: 1.0,
  restitution: 0,
  density: 0.01
});
Body.setPosition(spade, { x: width/2, y: height/4 });
World.add(world, spade);

// mouse control
const mouse = Mouse.create(render.canvas);
render.mouse = mouse;

// spade follows mouse
Events.on(engine, "beforeUpdate", () => {
  const target = mouse.position;
  const dx = target.x - spade.position.x;
  const dy = target.y - spade.position.y;

  // smooth movement
  Body.setVelocity(spade, { x: dx * 0.25, y: dy * 0.25 });

  // angle points in motion direction
  if (Math.abs(dx) + Math.abs(dy) > 0.1) {
    const angle = Math.atan2(dy, dx);
    Body.setAngle(spade, angle);
  }
});

// slight cohesion for soil
Events.on(engine, "afterUpdate", () => {
  for (let i = 0; i < blocks.length; i++) {
    for (let j = i+1; j < blocks.length; j++) {
      const b1 = blocks[i], b2 = blocks[j];
      const dx = b2.position.x - b1.position.x;
      const dy = b2.position.y - b1.position.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < blockSize * 2.2) {
        const force = 0.00002; // weaker than before
        Body.applyForce(b1, b1.position, { x: dx * force, y: dy * force });
        Body.applyForce(b2, b2.position, { x: -dx * force, y: -dy * force });
      }
    }
  }
});
</script>
</body>
</html>
